---
- name: Ensure that the caretaker user is present
  ios_user:
    name: caretaker
    privilege: 15
    nopassword: true
    sshkey: ../files/caretaker_telco.pub
    state: present

- name: Push device configs
  command: "scp -i {{ secret_key }} -o StrictHostKeyChecking=no  /archived_configs/{{ inventory_hostname }}/config/running.cfg caretaker@{{ inventory_hostname }}:/running.config"

- name: Enable archive
  ios_config:
    parents:
      - archive
    lines:
      - "path flash:"

# - name: register the ssh key for scp
#   copy:
#     contents: "{{ ansible_password }}"
#     dest: "{{ playbook_dir }}/ssh_key"
#   delegate_to: localhost
#   run_once: yes

# - name: Replace config
#   ios_command:
#     commands:
#       - show privilege
#       - show user


# - name: Push device configs
#   command: "scp -i /home/ec2-user/.ssh/aws-private.pem -o StrictHostKeyChecking=no  /archived_configs/{{ inventory_hostname }}/config/running.cfg ec2-user@{{ inventory_hostname }}:/running.config"
#   become: yes

# - name: Replace config
#   ios_command:
#     commands:
#       - show privilege
#       - show user

- name: Replace config
  ios_command:
    commands:
      - config replace flash:running.config force
